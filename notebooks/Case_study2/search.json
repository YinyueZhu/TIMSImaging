[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Case study 2: microbial culture natural product dataset",
    "section": "",
    "text": "In this case study, we perform differential abundance analysis on a MALDI-TIMS-MS1 natural products dataset of bacterial-fungal co-culture. First we processed the data in TIMSImaging, followed by a non-spaital Wilcoxon rank-sum test to get results comparable to the literature. Then we explore further using mixed effect models in R, contrast 1) non-spatial and spatial modeling, 2) processing with and without ion mobility. The purpose of this case study is to show that TIMSImaging creates informative features, which enables selecting precursors associated with specific regions as prioritized targets in the following MS2 imaging experiment design.\nThe dataset is from Laura Sanchez Lab and available on MASSIVE(MSV000097837).\nShepherd, R. A., G. T. Luu and L. M. Sanchez (2025). “MALDI-TIMS-MS(2) Imaging and Annotation of Natural Products in Fungal-Bacterial Coculture.” Anal Chem 97(35): 18867-18872.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Overview</span>"
    ]
  },
  {
    "objectID": "5-microbial_culture.html",
    "href": "5-microbial_culture.html",
    "title": "2  Data processing in TIMSImaging and rank-sum test",
    "section": "",
    "text": "2.1 Introcution\nIn this part, we process the MALDI-TIMS-MS1 dataset of bacterial-fungal co-culture, then find features with high intensity in the microbioal region, and export the processed data in the open imzML format.\nimport timsimaging\n\n# enable visualization in the Jupyter notebook\nfrom bokeh.io import show, output_notebook\noutput_notebook()\n# disable FutureWarning\nimport warnings\nwarnings.filterwarnings('ignore')\n\n    \n    \n        \n        Loading BokehJS ...",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data processing in TIMSImaging and rank-sum test</span>"
    ]
  },
  {
    "objectID": "5-microbial_culture.html#introcution",
    "href": "5-microbial_culture.html#introcution",
    "title": "2  Data processing in TIMSImaging and rank-sum test",
    "section": "",
    "text": "2.1.1 Load MALDI-TIMS-TOF raw data\n\nbruker_d_folder_name = r\"D:\\dataset\\Laura_Gordon\\250321_JB182_Pen12.d\"\ndataset = timsimaging.spectrum.MSIDataset(bruker_d_folder_name)\ndataset\n\nMSIDataset with 12173 pixels\n        mz range: 99.999-1100.005\n        mobility range: 0.400-1.800",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data processing in TIMSImaging and rank-sum test</span>"
    ]
  },
  {
    "objectID": "5-microbial_culture.html#understanding-experiment-setting",
    "href": "5-microbial_culture.html#understanding-experiment-setting",
    "title": "2  Data processing in TIMSImaging and rank-sum test",
    "section": "2.2 Understanding experiment setting",
    "text": "2.2 Understanding experiment setting\nAs the TIC image shows, there are 4 regions: G.arilaitensis + P.solitum co-culuture(top), P.solitum(bottom left), G.arilaitensis(bottom middle) and the media/matrix(bottom right)\n\ndataset.image()\n\n\n  \n\n\n\n\n\n\n2.2.1 Peak processing\nThe first step is to extract features. Due to the heterogeneity of regions, we set sampling_ratio to 1 so that all pixels are used for mean spectrum calculation.\n\nresults = dataset.process(sampling_ratio=1, frequency_threshold=0.05, intensity_threshold=0.001, tolerance=3, window_size=[30, 7], visualize=True)\n\nComputing mean spectrum...\nTraversing graph...\nFinding local maxima...\nSummarizing...\n\n\nHere we get 784 features in total, each of them corresponds to an ion image.\n\ntable, _ = timsimaging.plotting.feature_list(results[\"peak_list\"])\n\n\nshow(table)\n\n\n  \n\n\n\n\n\n\nshow(results[\"viz\"])\n\n\n\n\n\n\n2.2.2 Differential analysis using Wilcoxon rank-sum test\nFor precursor targets in following MS2 experiments, we want to select ions relevant to cell culture and exclude matrix ions. Specifically, a desired precursor should be associate with the microbioal culture region, with minimum intensity in the matrix region. We referred the paper below, which uses a non-spatial Wilcoxon rank-sum test.\nRauser, S., C. Marquardt, B. Balluff, S.-O. Deininger, C. Albers, E. Belau, R. Hartmer, D. Suckau, K. Specht, M. P. Ebert, M. Schmitt, M. Aubele, H. Höfler and A. Walch (2010). “Classification of HER2 Receptor Status in Breast Cancer Tissues by MALDI Imaging Mass Spectrometry.” Journal of Proteome Research 9(4): 1854-1863.\n\nimport numpy as np\nfrom scipy.stats import mannwhitneyu\n\n\nintensity_array = results[\"intensity_array\"]\n\nHere we use the same ROI setting as the original paper: the media/matrix region as group 1, while all other region as group 2, treat pixels as samples and test if there is a signifcant intensity difference between two groups.\n\ndataset.set_ROI(\"matrix\", xmin=200, ymin=100)\nmatrix = intensity_array.loc[dataset.rois[\"matrix\"]]\ncultures = intensity_array.loc[np.setdiff1d(intensity_array.index, dataset.rois[\"matrix\"])]\n\nApply RMS normalization to each group before the test:\n\n# RMS normalization\nrms = np.sqrt(np.mean(np.square(intensity_array), axis=1))\nintensity_array_norm = intensity_array.div(rms, axis=0)\n\nmatrix = intensity_array_norm.loc[dataset.rois[\"matrix\"]]\ncultures = intensity_array_norm.loc[np.setdiff1d(intensity_array.index, dataset.rois[\"matrix\"])]\n\nCompute the statistics and fold change.\n\nstat, p = mannwhitneyu(cultures, matrix)\nstats = results[\"peak_list\"].copy()\nstats[\"culture_mean\"] = np.mean(cultures, axis=0).to_numpy()\nstats[\"matrix_mean\"] = np.mean(matrix, axis=0).to_numpy()\nstats[\"log2foldchange\"] = np.log2(np.mean(cultures, axis=0)/np.mean(matrix, axis=0)).to_numpy()\nstats[\"neg_log10_pvalue\"] = -np.log10(p)\nstats\n\n\n\n\n\n\n\n\nmz_values\nmobility_values\ntotal_intensity\nculture_mean\nmatrix_mean\nlog2foldchange\nneg_log10_pvalue\n\n\n\n\n26\n172.040229\n0.627523\n2306.307730\n0.059480\n0.068297\n-0.199415\n3.851708\n\n\n41\n187.055019\n0.614947\n1350.618829\n0.042400\n0.027598\n0.619482\n13.634440\n\n\n45\n189.070660\n0.618844\n3353.983734\n0.101712\n0.074469\n0.449772\n13.680900\n\n\n47\n190.050757\n0.964792\n884.310605\n0.025086\n0.027849\n-0.150782\n4.633008\n\n\n75\n201.059263\n0.651327\n1019.046168\n0.033806\n0.020592\n0.715197\n15.615291\n\n\n...\n...\n...\n...\n...\n...\n...\n...\n\n\n6602\n1079.112242\n1.511486\n4353.308634\n0.138639\n0.126743\n0.129429\n1.366319\n\n\n6614\n1088.066520\n1.557763\n1397.371889\n0.044244\n0.015218\n1.539681\n62.449167\n\n\n6618\n1088.067282\n1.464957\n1019.910129\n0.033066\n0.011269\n1.553035\n51.979610\n\n\n6623\n1089.070123\n1.484550\n835.687998\n0.026375\n0.009408\n1.487155\n49.901634\n\n\n6636\n1094.083050\n1.511502\n3821.645773\n0.119431\n0.066028\n0.855034\n45.896223\n\n\n\n\n784 rows × 7 columns\n\n\n\n\n\n2.2.3 Visualize results in a volcano plot\n\nfrom bokeh.plotting import figure,show\nfrom bokeh.models import ColumnDataSource, HoverTool\nfrom bokeh.transform import factor_cmap\n\nNow we can make a volcano plot. The features to be selected is on the top right, that present high signal-to-noise ratio and high significance score.\n\nf = figure(\n    title=\"Differential abundance\",\n    match_aspect=True,\n    toolbar_location=\"right\",\n    x_axis_label=\"log2foldchange\",\n    y_axis_label=\"neg_log10_pvalue\",\n    x_range=(-10,10)\n)\nsource = ColumnDataSource(stats)\nvolcano = f.scatter(x=\"log2foldchange\",\n          y=\"neg_log10_pvalue\",\n          source = source)\nhover = HoverTool(renderers=[volcano], tooltips=[\n            (\"m/z\", \"@mz_values{0.0000}\"),\n            (\"1/K0\", \"@mobility_values{0.0000}\"),\n            (\"index\", \"$index\"),\n        ],)\nf.add_tools(hover)\nshow(f)\n\n\n  \n\n\n\n\n\n\n\n2.2.4 Corroborate differential features in literature\nHere is the features reported in the literature, using the “find discriminating” funtion in SCiLS Lab. We retrieve them in the feature list and look where they are in the volcano plot.\n\ntarget = np.array([\n    417.2348,\n    425.2625,\n    428.2594,\n    475.2532,\n    532.3086,\n    588.3737,\n    615.3198,\n    627.3479,\n    655.2726,\n])\n\nAll those features were detected by TIMSImaging, with minimal m/z differences.\n\nindices = []\nfor m in target:\n    mz_tol = m * 50 * 1e-6\n    index = np.nonzero(stats['mz_values'].between(m-mz_tol, m+mz_tol))[0]\n    indices.append(index[0])\nstats.iloc[indices]\n\n\n\n\n\n\n\n\nmz_values\nmobility_values\ntotal_intensity\nculture_mean\nmatrix_mean\nlog2foldchange\nneg_log10_pvalue\n\n\n\n\n1757\n417.245748\n0.948254\n2343.955229\n0.079047\n0.000924\n6.418199\n152.039042\n\n\n1860\n425.261619\n0.975195\n3731.217038\n0.117055\n0.002412\n5.600804\n129.732154\n\n\n1900\n428.261729\n0.960216\n3326.308223\n0.111457\n0.001042\n6.741408\n172.427855\n\n\n2509\n475.254336\n1.006788\n2615.506695\n0.085422\n0.002050\n5.381051\n154.746667\n\n\n3280\n532.309080\n1.081939\n1673.549659\n0.056178\n0.004467\n3.652642\n102.566166\n\n\n4028\n588.373038\n1.151386\n1445.407788\n0.048771\n0.001496\n5.026967\n95.400457\n\n\n4378\n615.320932\n1.144504\n1024.922287\n0.036958\n0.001301\n4.828456\n115.224511\n\n\n4544\n627.353146\n1.177115\n958.086092\n0.031236\n0.001508\n4.372415\n132.199016\n\n\n4843\n655.273642\n1.272451\n2910.554342\n0.091324\n0.002353\n5.278412\n140.796247\n\n\n\n\n\n\n\n\nstats[\"target\"] = \"No\"\nstats[\"target\"].iloc[indices] = \"Yes\"\n\nNow we can view the position of these precursors in the volcano plot:\n\n#func = lambda df: (df.log2foldchange&gt;4)&(df.neg_log10_pvalue&gt;50)&(df.matrix_mean&lt;1000)\n#source.add(np.where(func(stats), \"Orange\", \"Steelblue\"), name=\"color\")\nsource = ColumnDataSource(stats)\na = figure(\n    title=\"Differential abundance\",\n    match_aspect=True,\n    toolbar_location=\"right\",\n    x_axis_label=\"log2foldchange\",\n    y_axis_label=\"neg_log10_pvalue\",\n    x_range=(-10,10)\n)\nvolc = a.scatter(x=\"log2foldchange\",\n          y=\"neg_log10_pvalue\",\n                 \n          color = factor_cmap(\"target\", [\"Steelblue\", \"Orange\"], [\"No\", \"Yes\"]),\n          #color = 'color',\n          source = source)\nhover = HoverTool(renderers=[volcano], tooltips=[\n            (\"m/z\", \"@mz_values{0.0000}\"),\n            (\"1/K0\", \"@mobility_values{0.0000}\"),\n            (\"index\", \"$index\"),\n        ],)\na.add_tools(hover)\nshow(a)\n\n\n  \n\n\n\n\n\nSimilar to the internal function in SCiLS, Wilcoxon rank-sum test outputs significant p values for these features. Deisotoping and applying an intensity filtration would result a more concrete precursor candidate list.\n\n\n2.2.5 Export the processed data in imzML format\nFinally, export processed data for further differential analysis in R.\n\ntimsimaging.spectrum.export_imzML(dataset, path=r\"D:\\dataset\\laura_gordon\", peaks=results)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data processing in TIMSImaging and rank-sum test</span>"
    ]
  },
  {
    "objectID": "6-precursor_selection.html",
    "href": "6-precursor_selection.html",
    "title": "3  Differential abundance analysis in R",
    "section": "",
    "text": "3.1 Introduction\nIn this part, we continue to perform differential abundance analysis on the processed imzML from Section 1 to find precursors that present high intensity in the microbial culture region. First we apply a non-spatial linear fixed effects model, then explore modeling with spatial correlation. In addition, we also contrast differential analysis on features with and without ion mobility.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Differential abundance analysis in R</span>"
    ]
  },
  {
    "objectID": "6-precursor_selection.html#introduction",
    "href": "6-precursor_selection.html#introduction",
    "title": "3  Differential abundance analysis in R",
    "section": "",
    "text": "3.1.1 Package setup\nWe will use Cardinal for data import and normalization, spaMM for differential analysis and ggplot2 for visualization. If the packages are not yet installed, run following code in a R session:\n\nif (!require(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\n\nBiocManager::install(\"Cardinal\")\npackage.install(\"spaMM\")\npackage.install(\"ggplot2\")\n\nThen load the packages:\n\nlibrary(Cardinal)\nlibrary(spaMM)\nlibrary(ggplot2)\n\n\n\n3.1.2 Load processed dataset\nFirst we load the processd imzML from TIMSImaging into Cardinal:\n\nmsa &lt;- readMSIData(\"D:\\\\dataset\\\\Laura_Gordon\\\\laura_gordon.imzML\", as=\"MSImagingArrays\", extraArrays=c(mobility=\"MS:1003006\"))\nmse &lt;- convertMSImagingArrays2Experiment(msa)\nmse\n\nMSImagingExperiment with 781 features and 12173 spectra \nspectraData(1): intensity\nfeatureData(1): mz\npixelData(3): x, y, run\ncoord(2): x = 37...236, y = 31...154\nrunNames(1): laura_gordon\nexperimentData(5): spectrumType, spectrumRepresentation, lineScanSequence, scanType, lineScanDirection\nmass range:  172.0402 to 1094.0830 \ncentroided: TRUE \n\n\ncheck the regions:\n\nimage(mse)\n\n\n\n\n\n\n\n\n\n\n3.1.3 Data preparation\nThen we label 3 microbioal regions as a group(culture) and the matrix region as the other group(media), which is consistent with the literature.\n\ncoords &lt;- coord(mse)\npixel_label &lt;- ifelse(coords$x &gt; 200 & coords$y &gt; 100, \"media\", \"culture\")\npData(mse)$label &lt;- factor(pixel_label)\npData(mse)\n\nPositionDataFrame with 12173 rows and 4 columns\n                       x         y          run    label\n               &lt;numeric&gt; &lt;numeric&gt;     &lt;factor&gt; &lt;factor&gt;\nspectrum=1            46        31 laura_gordon  culture\nspectrum=2            47        31 laura_gordon  culture\nspectrum=3            48        31 laura_gordon  culture\nspectrum=4            49        31 laura_gordon  culture\nspectrum=5            50        31 laura_gordon  culture\n...                  ...       ...          ...      ...\nspectrum=12169       232       133 laura_gordon    media\nspectrum=12170       233       133 laura_gordon    media\nspectrum=12171       234       133 laura_gordon    media\nspectrum=12172       235       133 laura_gordon    media\nspectrum=12173       236       133 laura_gordon    media\ncoord(2): x, y\nrun(1): run\n\n\nTo reduce the complexity of spatial modeling, we just compare the G.arilaitensis(bottom middle) region(culture) and the media/matrix region(media). For targets in following MS2 acquisition, we want to exclude matrix/media ions and select precursors spatially associated with the microbioal culture region. Specifically, a desired precursor should present high intensity in the microbioal culture region and minimum intensity in the matrix/media region.\n\n\nmse_subset &lt;- subsetPixels(mse, x&gt;120, y&gt;100)\nimage(mse_subset)\n\n\n\n\n\n\n\n\nFirst we try differential abundance analysis on a feature(mz=428.26) reported in the paper. Extract the ion image as a data frame, with pixels labeled as either in ‘media’ or ‘culture’ region.\n\nm &lt;- 428.26\ni &lt;- findInterval(m, mz(mse_subset))+1\nintensity &lt;- spectraData(mse_subset)$intensity[i,]\ndf &lt;- data.frame(\n  intensity = intensity,\n  label = pData(mse_subset)$label,\n  x = pData(mse_subset)$x,\n  y = pData(mse_subset)$y\n)\n# set the media group as the baseline\ndf$label &lt;- relevel(df$label, ref=\"media\")\n\nPlot its ion image:\n\nimage(mse_subset, i=i)\n\n\n\n\n\n\n\n\n\n\n3.1.4 Fitting a non-spatial model\nNow we fit a non-spatial linear fixed effect model on this feature. Let \\(s\\) be a pixel position, \\(k\\) be a group label, then the intensity is a linear response to group label: \\[y_s=\\mu_k+\\varepsilon_s\\] where \\(y_s\\) is the intensity at \\(s\\), the fixed effect \\(\\mu_k\\) is the mean intensity in group \\(k\\), \\(\\varepsilon_s\\) is the random error.\n\nmodel &lt;- fitme(\n    intensity ~ label,\n    data = df,\n    method = \"REML\",\n)\nsummary.HLfit(model, details=c(p_value=\"Wald\"))\n\nformula: intensity ~ label\nEstimation of fixed effects by ML.\nEstimation of phi by 'outer' REML, maximizing restricted logL.\nfamily: gaussian( link = identity ) \n ------------ Fixed effects (beta) ------------\n             Estimate Cond. SE t-value p-value\n(Intercept)     35.59    162.1  0.2195  0.8263\nlabelculture  4070.59    176.9 23.0093  0.0000\n -------------- Residual variance  ------------\nphi estimate was 7492370 \n ------------- Likelihood values  -------------\n                        logLik\nlogL               : -16622.21\nlog restricted-lik : -16611.02\n\n\nThe result shows that ion m/z=428.26 present higher intensity in the culture region(labelculture) than the media region(intercept) with high significance score. However, in the non-spatial modeling the pixels were considered as independent samples, which is not true(pixels are highly correlated), the degree of freedom is overstimated and resulted in extremely small p-vales(type-I error).\n\n\n3.1.5 Fitting a spatial model\nNext, we try a spatial linear mixed effect model with Matern correlation. The model could be expressed as \\[y_s=\\mu_k+U_s+\\varepsilon_s\\] where \\(y_s\\) is the intensity at \\(s\\), the fixed effect \\(\\mu_k\\) is the mean intensity in group \\(k\\), the random effect \\(U_s\\) is the Matérn random field at \\(s\\), and \\(\\varepsilon_s\\) is the random error.\n\nmodel &lt;- fitme(\n    intensity ~ label + Matern(1|x+y),\n    data = df,\n    method = \"REML\",\n)\nsummary.HLfit(model, details=c(p_value=\"Wald\"))\n\nformula: intensity ~ label + Matern(1 | x + y)\nREML: Estimation of corrPars, lambda and phi by REML.\n      Estimation of fixed effects by ML.\nEstimation of lambda and phi by 'outer' REML, maximizing restricted logL.\nfamily: gaussian( link = identity ) \n ------------ Fixed effects (beta) ------------\n             Estimate Cond. SE t-value   p-value\n(Intercept)     26.59     1347 0.01974 0.9842505\nlabelculture  5279.35     1578 3.34540 0.0008216\n --------------- Random effects ---------------\nFamily: gaussian( link = identity ) \n                   --- Correlation parameters:\n      1.nu      1.rho \n0.19882987 0.04176932 \n           --- Variance parameters ('lambda'):\nlambda = var(u) for u ~ Gaussian; \n   x + y  :  5112000  \n# of obs: 1781; # of groups: x + y, 1781 \n -------------- Residual variance  ------------\nphi estimate was 3272180 \n ------------- Likelihood values  -------------\n                        logLik\nlogL       (p_v(h)): -16315.52\nRe.logL  (p_b,v(h)): -16299.60\n\n\nThe spatial model also shows the differential abundance between two regions, but with more reasonable p-value.\n###Fitting non-spatial and spatial model on all features Then we can loop over all features by fitting a model on each of them:\n\nnonspatial_de &lt;-function(mse){\n  mz_values &lt;- mz(mse)\n  fit_results &lt;- lapply(seq_along(mz_values), function(i) {\n  intensity_i &lt;- spectraData(mse)$intensity[i, ]\n  \n  # create a subset data frame\n  sub_df &lt;- data.frame(\n    intensity = intensity_i,\n    label = pData(mse)$label,\n    x = coord(mse)$x,\n    y = coord(mse)$y\n  )\n  # set the media group as the baseline\n  sub_df$label &lt;- relevel(sub_df$label, ref=\"media\")\n  # fit a linear fixed effect model\n  model &lt;- tryCatch({\n    fitme(intensity ~ label,\n          data = sub_df,\n          method = \"REML\")\n  }, error = function(e) NULL)\n  \n  # summarize the results\n  if (!is.null(model)) {\n    #coefs &lt;- fixed.effects(model)\n    stats &lt;- summary.HLfit(model, details=c(p_value=\"Wald\"), verbose=FALSE)[['beta_table']]\n    \n    return(data.frame(\n      mz = mz_values[i],\n      index = i,\n      intercept = stats[1,1],\n      label_effect = stats[2,1],\n      t_value = stats[2,3],\n      p_value = stats[2,4]\n    ))\n  } else {\n    return(NULL)\n  }\n})\n# combine all results\nfit_results_df &lt;- do.call(rbind, fit_results)\nfit_results_df$intensity &lt;- fit_results_df$intercept+fit_results_df$label_effect\nfit_results_df$log2_foldchange &lt;- log2((fit_results_df$intercept+fit_results_df$label_effect)/fit_results_df$intercept)\nfit_results_df$neg_log10_p &lt;- pmin(-log10(fit_results_df$p_value), 20)\nreturn(fit_results_df)\n}\n\nSummarize the results:\n\nfit_results_df &lt;- nonspatial_de(mse_subset)\nhead(fit_results_df, 10)\n\n         mz index intercept label_effect    t_value p_value intensity\n1  172.0402     1 2743.7439   -1577.9945 -16.517216       0 1165.7493\n2  187.0550     2 1008.0175     887.5974  13.303868       0 1895.6150\n3  189.0707     3 2753.1754    1225.5625  10.933209       0 3978.7380\n4  190.0508     4 1054.0000    -403.6845 -13.734408       0  650.3155\n5  201.0593     5  754.3474     813.6653  14.013560       0 1568.0127\n6  202.0783     6  777.3088     654.8363  13.810138       0 1432.1451\n7  203.0734     7  776.4386     601.9418  13.041554       0 1378.3803\n8  204.0812     8 1640.6281    1148.1520  13.707021       0 2788.7801\n9  205.0654     9 1014.4842     374.1428   8.819151       0 1388.6270\n10 214.0656    10 4392.1018    4708.4363  14.635449       0 9100.5381\n   log2_foldchange neg_log10_p\n1       -1.2348882          20\n2        0.9111452          20\n3        0.5312143          20\n4       -0.6966631          20\n5        1.0556363          20\n6        0.8816179          20\n7        0.8280303          20\n8        0.7653860          20\n9        0.4529127          20\n10       1.0510404          20\n\n\nHere is the code for spatial model:\n\nspatial_de &lt;- function(mse){\n  mz_values &lt;- mz(mse)\n  fit_results &lt;- lapply(seq_along(mz_values), function(i) {\n    message(\"Fitting feature\", i)\n    intensity_i &lt;- spectraData(mse)$intensity[i, ]\n  \n    sub_df &lt;- data.frame(\n      intensity = intensity_i,\n      label = pData(mse)$label,\n      x = coord(mse)$x,\n      y = coord(mse)$y\n    )\n    sub_df$label &lt;- relevel(sub_df$label, ref=\"media\")\n  \n    model &lt;- tryCatch({\n      fitme(intensity ~ label + Matern(1|x+y),\n            data = sub_df,\n            fixed = list(nu=0.5),\n            control.HLfit = list(algebra=\"spcorr\", NbThreads=8),\n            method = \"REML\")\n    }, error = function(e) NULL)\n    \n    if (!is.null(model)) {\n      coefs &lt;- fixed.effects(model)\n      stats &lt;- summary.HLfit(model, details=c(p_value=\"Wald\"), verbose=FALSE)[['beta_table']]\n      \n      return(data.frame(\n        mz = mz_values[i],\n        intercept = coefs[1],\n        label_effect = coefs[2],\n        t_value = stats[2,3],\n        p_value = stats[2,4]\n      ))\n    } else {\n      return(NULL)\n    }\n  })\n  fit_results_df &lt;- do.call(rbind, fit_results)\n  fit_results_df$log2_foldchange &lt;- log2((fit_results_df$intercept+fit_results_df$label_effect)/fit_results_df$intercept)\n  fit_results_df$neg_log10_p &lt;- pmin(-log10(fit_results_df$p_value), 20)\n  return(fit_results_df)\n}\n\nIt takes hours to run the spatial model on all the features. For presentation here we load the pre-computed results:\n\nfit_results_df_sp &lt;- read.csv(\"D:\\\\dataset\\\\Laura_Gordon\\\\spatial_model_results.csv\")\nhead(fit_results_df_sp, 10)\n\n         mz intercept label_effect   t_value      p_value log2_foldchange\n1  172.0402 2870.8918   -1852.1692 -3.813199 0.0001371793      -1.4947377\n2  187.0550 1032.1892    1143.4519  2.324345 0.0201070065       1.0757331\n3  189.0707 3142.2868    1406.1612  1.569304 0.1165770829       0.5335595\n4  190.0508 1066.5681    -513.1645 -2.867744 0.0041340929      -0.9465722\n5  201.0593  826.7352     983.1938  2.384268 0.0171131320       1.1304359\n6  202.0783  916.4583     686.2478  1.955258 0.0505525712       0.8063687\n7  203.0734  913.1006     671.3881  2.131018 0.0330876572       0.7951717\n8  204.0812 1765.4276    1434.6161  2.329726 0.0198206294       0.8580740\n9  205.0654 1267.1642     472.7607  1.076814 0.2815634507       0.4574216\n10 214.0656 5172.3841    5307.5780  2.215906 0.0266979208       1.0187322\n   neg_log10_p\n1    3.8627114\n2    1.6966526\n3    0.9333868\n4    2.3836198\n5    1.7666705\n6    1.2962568\n7    1.4803340\n8    1.7028826\n9    0.5504237\n10   1.5735226\n\n\nNow we can visualize the results with volcano plots.\n\nvolcano_plot &lt;- function(df){\n  p &lt;- ggplot(df, aes(x = log2_foldchange, y = neg_log10_p)) +\n    geom_point(alpha = 0.7) +\n    geom_hline(yintercept = -log10(0.05), color = \"red\", linetype = \"dashed\") +  # p=0.05 threshold\n    geom_vline(xintercept = 0, color = \"blue\", linetype = \"dotted\") +\n    labs(\n      title = \"Volcano Plot of m/z Features\",\n      x = \"log2(fold change)\",\n      y = \"-log10(p-value)\"\n    ) +\n    coord_cartesian(xlim = c(-5, 5), ylim=c(0,20)) +\n    theme_minimal()\n  return(p)\n}\n\n\nvolcano_plot(fit_results_df)\n\n\n\n\n\n\n\nvolcano_plot(fit_results_df_sp)\n\n\n\n\n\n\n\n\nThe spatial modeling resulted in a more reasonable volcano plot. Points on the top right(significantly up-expressed in the microbial culture region with high fold change) are the candidate precursors. For example,\n\nselected_precursors &lt;- subset(fit_results_df_sp, (log2_foldchange&gt;2) & (p_value&lt;0.05))\nselected_precursors &lt;- selected_precursors[order(selected_precursors$neg_log10_p, decreasing = TRUE),]\nhead(selected_precursors, 10)\n\n          mz intercept label_effect   t_value      p_value log2_foldchange\n294 439.2909  87.68310     699.8994 12.207582 0.000000e+00        3.167060\n319 457.2630  81.43585    1054.3189  8.500808 0.000000e+00        3.801844\n446 545.2354  65.71369     419.6170  5.524842 3.297832e-08        2.884702\n374 491.2311  37.80553     402.0757  5.512629 3.535136e-08        3.540445\n367 488.2501  53.84855    1369.3657  5.479604 4.262793e-08        4.724101\n328 461.2725  56.87537     832.7660  5.385277 7.233332e-08        3.967348\n353 479.2486 141.22950    1343.3214  5.332992 9.660731e-08        3.393913\n409 523.2550 105.22080     676.1195  5.165406 2.399180e-07        2.892531\n397 510.2310  77.99742    1913.4726  5.090496 3.571283e-07        4.674263\n292 439.1950  99.20545    4620.6606  4.890073 1.007983e-06        5.572183\n    neg_log10_p\n294   50.000000\n319   50.000000\n446    7.481772\n374    7.451594\n367    7.370306\n328    7.140662\n353    7.014990\n409    6.619937\n397    6.447176\n292    5.996547\n\n\nPlot ion images for some example precursors with differential abundance:\n\nindices = as.numeric(row.names(selected_precursors)[1:6])\nimage(mse_subset, i=indices)\n\n\n\n\n\n\n\n\n\n\n3.1.6 Processing TIMSCONVERT data\nIn order to show ion mobility also benefits differential abundance analysis, we contrast the results from processing without ion mobility.\n\nmsa_timsconvert &lt;- readMSIData(\"D:\\\\dataset\\\\Laura_Gordon\\\\250321_JB182_Pen12.imzML\")\nmse_timsconvert_binned &lt;- bin(msa_timsconvert, resolution=20, units=\"ppm\")\ncentroided(mse_timsconvert_binned)&lt;-FALSE\nset.seed(42, kind=\"L'Ecuyer-CMRG\")\npeaks_timsconvert &lt;- peakProcess(mse_timsconvert_binned, SNR=6, tolerance=400, units=\"ppm\")\n\nThen we filtered the features by intensity and got 378 features.\n\npeaks_timsconvert &lt;- summarizeFeatures(peaks_timsconvert)\nmax_intensity &lt;- max(fData(peaks_timsconvert)$mean)\nintensity_filter &lt;- fData(peaks_timsconvert)$mean &gt; 0.01*max_intensity\npeaks_timsconvert &lt;- subsetFeatures(peaks_timsconvert, select=intensity_filter)\npeaks_timsconvert\n\nMSImagingExperiment with 378 features and 12173 spectra \nspectraData(1): intensity\nfeatureData(4): mz, count, freq, mean\npixelData(3): x, y, run\ncoord(2): x = 37...236, y = 31...154\nrunNames(1): 250321_JB182_Pen12\nmetadata(2): processing_20260106133523, processing_20260106133624\nexperimentData(5): spectrumType, spectrumRepresentation, lineScanSequence, scanType, lineScanDirection\nmass range:  172.0407 to 1095.0892 \ncentroided: TRUE \n\n\nHere is the code to run spatial-aware differential abundance analysis on these features, for time being we also use pre-computed results.\n\npData(peaks_timsconvert)$label &lt;- factor(pixel_label)\npeaks_timsconvert_subset &lt;- subsetPixels(peaks_timsconvert, x&gt;120, y&gt;100)\nfit_results_df_timsconvert &lt;- nonspatial_de(peaks_timsconvert_subset)\n\n\nfit_results_df_timsconvert &lt;- read.csv(\"D:\\\\dataset\\\\Laura_Gordon\\\\spatial_timsconvert.csv\")\n\nNext we find the matching features between with and without ion mobility. Since there could be multiple isobaric features differentiated by ion mobility and detected by TIMSImaging, a mz_noim value might match with multiple mz_im values.\n\nmz_im &lt;- fit_results_df_sp$mz\nmz_noim &lt;- fit_results_df_timsconvert$mz\nidx &lt;- sapply(mz_im, function(v) which.min(abs(mz_noim - v)))\nspatialde_results &lt;- data.frame(\n  mz_im = mz_im,\n  mz_noim = mz_noim[idx],\n  mob = spectraData(msa)$mobility$'spectrum=1',\n  tolerance = (mz_im-mz_noim[idx])/mz_im,\n  fc_im = fit_results_df_sp$log2_foldchange,\n  fc_noim = fit_results_df_timsconvert$log2_foldchange[idx],\n  pvalue_im = fit_results_df_sp$neg_log10_p,\n  pvalue_noim = fit_results_df_timsconvert$neg_log10_p[idx]\n)\n# find features with high fold change\nspatialde_results &lt;- subset(spatialde_results, (abs(tolerance)&lt;5e-5) & (fc_im&gt;1))\nhead(spatialde_results, 10)\n\n      mz_im  mz_noim       mob     tolerance    fc_im   fc_noim pvalue_im\n10 214.0656 214.0648 0.6694399  3.764268e-06 1.018732 1.0773983  1.573523\n11 215.0710 215.0724 0.6675574 -6.546154e-06 1.030314 1.0101238  1.560817\n18 227.0735 227.0738 0.6857717 -1.464568e-06 1.252852 1.2403257  1.656022\n19 228.0797 228.0818 0.6865217 -8.946302e-06 1.211128 1.0259938  1.838233\n20 229.0762 229.0776 0.6973090 -5.781674e-06 2.196807 2.5045678  2.060626\n32 241.0760 241.0707 0.7123838  2.184876e-05 2.170429 2.0054843  2.216579\n46 256.0758 256.0762 0.7366803 -1.479089e-06 1.081612 1.1283892  1.865507\n48 257.0697 257.0766 0.7420743 -2.689380e-05 2.049206 0.9206352  2.151130\n49 257.0804 257.0766 0.7354503  1.487710e-05 1.222383 0.9206352  1.684749\n51 258.0785 258.0811 0.7425315 -9.830324e-06 1.888017 1.9253027  2.351527\n   pvalue_noim\n10    1.683095\n11    1.575105\n18    1.509311\n19    1.363297\n20    1.913232\n32    2.152838\n46    1.768733\n48    1.820350\n49    1.820350\n51    2.255194\n\n\nNow we can contrast the p-values for matched features. The x axis is the p-value processing without ion mobility, and the y axis is correponding ion moblity-aware p-value. Most points are above the diagonal, showing that the ion mobility-aware approach of TIMSImaging produced smaller p-values for differential abundance analysis.\n\nggplot(spatialde_results, aes(x = pvalue_noim, y = pvalue_im)) +\n  geom_point(alpha = 0.7) +\n  geom_abline(intercept = 0, slope = 1, color = \"red\", linetype = \"dashed\")+\n  labs(\n    title = \"Contrast of p-values\",\n    x = \"without ion mobility\",\n    y = \"with ion mobility\"\n  ) +\n  coord_fixed(ratio=1, xlim = c(0, 10), ylim=c(0,10))",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Differential abundance analysis in R</span>"
    ]
  }
]