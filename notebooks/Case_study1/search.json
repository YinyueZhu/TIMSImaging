[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Case study 1: mouse kidney peptide dataset",
    "section": "",
    "text": "In this case study, we analyze a MALDI-TIMS-TOF tryptic peptide dataset of mouse kidney tissue. First we processed the data in TIMSImaging, then performed segmentation in Cardinal, in addition we compared processing workflow with/without ion mobility. The dataset is from Melanie Föll Lab and available at MassIVE (MSV000096373).\nLi, M., Meyer, L., Meier, N., Witte, J., Maldacker, M., Seredynska, A., Schueler, J., Schilling, O. and Föll, M. (2025), Spatial Proteomics by Parallel Accumulation-Serial Fragmentation Supported MALDI MS/MS Imaging: A First Glance Into Multiplexed and Spatial Peptide Identification. Rapid Commun Mass Spectrom, 39: e10006. https://doi.org/10.1002/rcm.10006",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>Overview</span>"
    ]
  },
  {
    "objectID": "2-mouse_kidney.html",
    "href": "2-mouse_kidney.html",
    "title": "2  Data processing in TIMSImaging",
    "section": "",
    "text": "2.1 Introcution\nIn this part, we start from raw .d data, explore the dataset, perform peak processing, show separation by ion mobility and export the results in the open imzML format.\nimport timsimaging\n\n# enable visualization in the Jupyter notebook\nfrom bokeh.io import show, output_notebook\noutput_notebook()\n# disable FutureWarning\nimport warnings\nwarnings.filterwarnings('ignore')\n\n    \n    \n        \n        Loading BokehJS ...",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data processing in TIMSImaging</span>"
    ]
  },
  {
    "objectID": "2-mouse_kidney.html#intro",
    "href": "2-mouse_kidney.html#intro",
    "title": "2  Data processing in TIMSImaging",
    "section": "",
    "text": "2.1.1 Load MALDI-TIMS-TOF raw data\nSuppose we know nothing about this dataset. First we load the dataset and print basic information like pixel number and data range.\n\nbruker_d_folder_name = r\"D:\\dataset\\Kidney_MS1_ITO6.d\"\ndataset = timsimaging.spectrum.MSIDataset(bruker_d_folder_name)\ndataset\n\nMSIDataset with 38267 pixels\n        mz range: 799.998-2500.007\n        mobility range: 1.200-2.600\n        \n\n\n\n\n2.1.2 View summary image and tables\nThen we can view the TIC image without any processing, as the TIC intensities are stored in the Frames table in the raw tdf file. Hover on individual pixels to see the details like coordinates and intensity:\n\ndataset.image()\n\n\n  \n\n\n\n\n\nWe can view the underlying data as tables, too\n\n# pixel positions\ndataset.pos\n\n\n\n\n\n\n\n\nXIndexPos\nYIndexPos\n\n\nFrame\n\n\n\n\n\n\n1\n336\n175\n\n\n2\n337\n175\n\n\n3\n338\n175\n\n\n4\n339\n175\n\n\n5\n340\n175\n\n\n...\n...\n...\n\n\n38263\n737\n116\n\n\n38264\n738\n116\n\n\n38265\n739\n116\n\n\n38266\n740\n116\n\n\n38267\n741\n116\n\n\n\n\n38267 rows × 2 columns\n\n\n\n\n# metadata of pixels\ndataset.data.frames\n\n\n\n\n\n\n\n\nId\nTime\nScanMode\nMsMsType\nTimsId\nMaxIntensity\nSummedIntensities\nNumScans\nNumPeaks\nMzCalibration\nT1\nT2\nTimsCalibration\nPropertyGroup\nAccumulationTime\nRampTime\nPressure\nDenoised\n\n\n\n\n0\n0\n0.000000\n20\n0\n64\n0\n0\n1212\n0\n1\n25.630815\n23.592239\n1\n1\n59.47\n230.09\n2.055982\n0\n\n\n1\n1\n2.671587\n20\n0\n64\n688\n5346970\n1212\n76165\n1\n25.630815\n23.592239\n1\n1\n59.47\n230.09\n2.055982\n0\n\n\n2\n2\n2.941060\n20\n0\n210641\n637\n4998845\n1212\n71095\n1\n25.630815\n23.592239\n1\n1\n59.47\n230.09\n2.055982\n0\n\n\n3\n3\n3.210677\n20\n0\n407604\n605\n4793642\n1212\n67948\n1\n25.630815\n23.592239\n1\n1\n59.47\n230.09\n2.055982\n0\n\n\n4\n4\n3.480285\n20\n0\n595229\n626\n4705085\n1212\n66534\n1\n25.630938\n23.591317\n1\n1\n59.47\n230.09\n2.055983\n0\n\n\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n...\n\n\n38263\n38263\n10602.755832\n20\n0\n11938087511\n925\n4587513\n1212\n64378\n1\n25.666533\n23.497069\n1\n1\n59.47\n230.09\n2.055988\n0\n\n\n38264\n38264\n10603.025466\n20\n0\n11938264725\n720\n4511870\n1212\n63215\n1\n25.666508\n23.496083\n1\n1\n59.47\n230.09\n2.055988\n0\n\n\n38265\n38265\n10603.295060\n20\n0\n11938440038\n775\n4700548\n1212\n66076\n1\n25.666508\n23.496083\n1\n1\n59.47\n230.09\n2.055988\n0\n\n\n38266\n38266\n10603.564667\n20\n0\n11938622040\n626\n4648396\n1212\n65487\n1\n25.666508\n23.496083\n1\n1\n59.47\n230.09\n2.055988\n0\n\n\n38267\n38267\n10603.813145\n20\n0\n11938802286\n755\n4574022\n1212\n63950\n1\n25.666508\n23.496083\n1\n1\n59.47\n230.09\n2.055988\n0\n\n\n\n\n38268 rows × 18 columns\n\n\n\n\n\n2.1.3 Set region of interest(ROI)\nThe left region is the kidney tissue, we can use the set_ROI method to set the ROI by xmin, xmax, ymin, ymax parameters.\n\ndataset.set_ROI(name='kidney', xmax=500)\n\n\n\n2.1.4 Process selected ROI\nThen we run the processing pipline introduced in the basic use notebook.\n\nresults = dataset.process(sampling_ratio=0.1, frequency_threshold=0.02, tolerance=3, adaptive_window=True, roi='kidney', visualize=True)\n\nComputing mean spectrum...\nTraversing graph...\nFinding local maxima...\nSummarizing...\n\n\n\n\n2.1.5 View peak list\nWe can view the interactive peak list:\n\npeaklist = results[\"peak_list\"]\ntable, _ = timsimaging.plotting.feature_list(results[\"peak_list\"])\nshow(table)\n\n\n  \n\n\n\n\n\n\n\n2.1.6 View intensity distribution\nWe can also visualize the intensity distribution:\n\nresults[\"peak_list\"][\"total_intensity\"].hist()\n\n\n\n\n\n\n\n\n\n\n2.1.7 View Interactive Results\nUser can explore the results in the GUI. By clicking pixels in the image(top left), users can view its mass spectrum(bottom middle), mobilogram(top right) and 2D spectogram combining these two(top middle). Also, users can click entries in the peak list(bottom left) to investigate ion images and spectral details of that peak. The menu(bottom right) provide summarizing functions like TIC image and mean spectrum, as well as file export options. This requires a living Python session to render, here shows a screenshot:\n\nshow(results['viz'])\n\n\n\n\n\n\n2.1.8 Separate ions by ion mobility\nIsobaric ions, or ions with non-distinguishable m/z(for example, isomers) could be separated by ion mobility. As examples shown below, TIMSImaging detected both peaks.\n\nfrom bokeh.layouts import row\n\n\nisomer1, _  = timsimaging.plotting.image(dataset, i=1079, results=results)\nisomer2, _  = timsimaging.plotting.image(dataset, i=1080, results=results)\nshow(row(isomer1, isomer2))\n\n\n  \n\n\n\n\n\n\n\nisomer1, _  = timsimaging.plotting.image(dataset, i=1163, results=results)\nisomer2, _  = timsimaging.plotting.image(dataset, i=1164, results=results)\nshow(row(isomer1, isomer2))\n\n\n  \n\n\n\n\n\n\n\n\n\n2.1.9 Export the processed data in imzML format\nFinally, we export the processed data as continuous, centroid imzML file for downstream analysis in Cardinal.\n\ntimsimaging.spectrum.export_imzML(dataset, path=r\"D:/dataset/Kidney_MS1_ITO6\", peaks=results)",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>Data processing in TIMSImaging</span>"
    ]
  },
  {
    "objectID": "3-mouse_kidney_segmentation.html",
    "href": "3-mouse_kidney_segmentation.html",
    "title": "3  Downstream segmentation in Cardinal",
    "section": "",
    "text": "3.1 Introduction\nIn this part, we start from processed imzML data in Section 2, first show how ion mobility is stored, then perform spatial shrunken centorids to show that it is compatible with Cardinal, and further illustrate benefits of ion moblity by single ion image segmentation.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Downstream segmentation in Cardinal</span>"
    ]
  },
  {
    "objectID": "3-mouse_kidney_segmentation.html#introduction",
    "href": "3-mouse_kidney_segmentation.html#introduction",
    "title": "3  Downstream segmentation in Cardinal",
    "section": "",
    "text": "3.1.1 Cardinal setup\nFirst make sure Cardinal is installed. If not, run the code below in a R session:\n\nif (!require(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\n\nBiocManager::install(\"Cardinal\")\n\nThen load Cardinal:\n\nlibrary(\"Cardinal\")\n\n\n\n3.1.2 Load processed dataset\nThe raw .d dataset was processed by TIMSImaging and exported as continuous, centroided imzML format, that each pixel corresponds to a spectrum with 3 dimensions: mz, mobility and intensity; all spectra share the same mz and mobility domain.\nHere we use extraArrays to load ion mobility information, and MS:1003006 is the entry number for ion mobility.\n\nmsa &lt;- readMSIData(\"D:/dataset/Kidney_MS1_ITO6.imzML\", as=\"MSImagingArrays\", extraArrays=c(mobility=\"MS:1003006\"))\nmsa\n\nMSImagingArrays with 22978 spectra \nspectraData(3): intensity, mz, mobility\npixelData(3): x, y, run\ncoord(2): x = 204...409, y = 175...332\nrunNames(1): Kidney_MS1_ITO6\nexperimentData(5): spectrumType, spectrumRepresentation, lineScanSequence, scanType, lineScanDirection\ncentroided: TRUE \ncontinuous: TRUE \n\n\nCheck that we can access ion mobility now. The mobiity values are in \\(1/K_0\\):\n\nspectraData(msa)$mobility\n\n&lt;22978 length&gt; matter_list :: out-of-core list\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=1 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=2 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=3 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=4 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=5 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n                 [1]      [2]      [3]      [4]      [5]      [6] ...\n$spectrum=6 1.262920 1.287529 1.265770 1.290552 1.311340 1.210486 ...\n...\n(1.95 MB real | 0 bytes shared | 571.7 MB virtual)\n\n\n\n\n3.1.3 Coerce to MSImagingExperiment\nIn order to do downstream analysis, we need to convert the MSImagingArray object to MSImagingExperiment. Unfortunately, currently MSImagingExperiment does not support extra arrays and the mobility array would be discarded. However, we can do spatial analysis like segmentation anyway as the features are from ion mobility-awere peak picking(after conversion, isobaric ions are still distinct.)\n\nmse &lt;- convertMSImagingArrays2Experiment(msa)\n\n\n\n3.1.4 Spatial Shruken Centroids Segmentation\nHere we use multivariate spatial shrunken centroids(SSC) to cluster pixels into segments. We use a fixed segment number(k) with different sparsity(s). The larger s is, the more unimportant features would be ignored and not contribute to segmentation.\n\nset.seed(42, kind=\"L'Ecuyer-CMRG\")\nssc &lt;- spatialShrunkenCentroids(mse, r=1, k=3, s=c(0, 6, 12))\nssc\n\nResultsList of length 3\nnames(3): r=1,k=3,s=0 r=1,k=3,s=6 r=1,k=3,s=12\nmodel: SpatialShrunkenCentroids \n             r k  s  weights clusters sparsity      AIC       BIC\nr=1,k=3,s=0  1 3  0 gaussian        3     0.00 24880.18 124926.30\nr=1,k=3,s=6  1 3  6 gaussian        3     0.40 17379.63  87259.11\nr=1,k=3,s=12 1 3 12 gaussian        3     0.63 13264.84  66006.19\n\n\nWe can visualize the segmentation results and compare with the results from vendor’s SCiLS Lab software, which uses bisecting K-means. When s=6, SSC results in clear segments for Cortex(1), Medulla(2) and background(3).\n\nimage(ssc, i=1:3, type=\"probability\", layout=c(1,3))\n\n\n\n\n\n\n\n\n\n\n\nSCiLS result\n\n\nVisualize statistic profile for each segment. Use the plot function to show which mass features are associated with which segments, higher statistics means the feature has more contribution to corresponding segment. Here we visualize top-100 features for each segment.\n\nplot(ssc, i=1:3, n=100, linewidth=2, layout=c(3,1))\n\n\n\n\n\n\n\n\n\n\n3.1.5 Univariate segmentation on isobaric features\nHere we select two isobaric features, apply univariate Spatial Dirichlet Gaussian mixture models(DGMM) on them separately, and compare with segmentation that treats them as one feature.\nFirst plot ion images separately. Note that two features have apexes at the same mass location, but here we use the weighted average m/z to distinguish them in the MSImagingExperiment object(see the heatmap in Section 1).\n\ni &lt;- findInterval(1105.5, mz(mse))\n\nmobs &lt;- spectraData(msa)$mobility[[1]][c(i+1, i+2)]\nimg &lt;- image(mse, i=c(i+1, i+2), scale=TRUE)\n# add ion mobility in plot titles\nimg$labels &lt;- paste(img$labels, \"\\n1/K_0 = \", sprintf(\"%.3f\", mobs))\nplot(img)\n\n\n\n\n\n\n\n\nDGMM on individual features. Though two features are at the same m/z, i=2(1/K\\(_0\\)=1.533) has higher correlation with the sub-structures while i=1 is more uniformly distributed.\n\nions &lt;- subsetFeatures(mse, i=c(i+1, i+2))\n\nset.seed(42, kind=\"L'Ecuyer-CMRG\")\ndgmm &lt;- spatialDGMM(ions, r=1, k=3, weights=\"gaussian\")\nimage(dgmm, i=c(1,2), layout=c(1,2))\n\n\n\n\n\n\n\n\nPlot the ion image collapsing two features(ignore separation by ion mobility). Here we use the bin() function in Cardinal which sums intensities within 1 Da bin, as there are no other feature in the mass interval.\n\nsummed &lt;- bin(ions, resolution=1, units=\"mz\")\nimage(summed, i=2)\n\n\n\n\n\n\n\n\nDGMM on collapsed feature without ion mobility separation, the segmentation result is noisier than using feature(m/z = 1105.5277, 1/K\\(_0\\)=1.533) only. DGMM segmentation is usually used to find features whose segments colocalize with certain ROIs, on ion moblity-resolved data could help screening informative features more accurately.\n\ndgmm_summed &lt;- spatialDGMM(summed, r=1, k=3, weights=\"gaussian\")\nimage(dgmm_summed, i=2)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Downstream segmentation in Cardinal</span>"
    ]
  },
  {
    "objectID": "4-timsconvert_comparison.html",
    "href": "4-timsconvert_comparison.html",
    "title": "4  TIMSCONVERT workflow comparison",
    "section": "",
    "text": "4.1 Introduction\nIn this part, we compare TIMSImaging workflow with existing method that ignores ion mobility on the same mosue kidney peptide dataset. TIMSCONVERT is an open-source tool to convert general Bruker raw data into open formats, users could install from https://github.com/gtluu/timsconvert. Specifically, it outputs imzML for MALDI-TIMS-MS imaging data, either with ion mobility or not. However, it does NOT do any pre-processing.",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>TIMSCONVERT workflow comparison</span>"
    ]
  },
  {
    "objectID": "4-timsconvert_comparison.html#introduction",
    "href": "4-timsconvert_comparison.html#introduction",
    "title": "4  TIMSCONVERT workflow comparison",
    "section": "",
    "text": "4.1.1 Convert raw data using TIMSCONVERT\nFirst we use TIMSCONVERT to get unprocessed imzML. Note that unprocessed imzML with ion mobility is usually huge, we recommmend to do conversion using HPC.\n\n#!/bin/bash\n#SBATCH --nodes=1\n#SBATCH --time=4:00:00\n#SBATCH --job-name=Casestudy_timsconvert\n#SBATCH --mem=80G\n#SBATCH --partition=short\n#SBATCH -o output_%j.txt                    # Standard output file\n#SBATCH -e error_%j.txt                     # Standard error file\n#SBATCH --mail-user=zhu.yiny@northeastern.edu  # Email\n#SBATCH --mail-type=ALL                     # Type of email notifications\neval \"$(conda shell.bash hook)\"\nconda activate timsconvert\ncd /work/VitekLab/Data/MS/Melanie_manuscript/\ntimsconvert --input Kidney_MS1_ITO6.d --outdir mouse_kidney_timsconvert_output --compression none --mode centroid --verbose\nconda deactivate\n\n\n\n4.1.2 Process data from TIMSCONVERT\nLoad the imzML data from TIMSCONVERT, which is obtained by running the shell script.\n\nmsa &lt;- readMSIData(\"D:\\\\dataset\\\\Melanie_case_study\\\\Kidney_MS1_ITO6.imzML\")\nmsa\n\nMSImagingArrays with 38267 spectra \nspectraData(2): intensity, mz\npixelData(3): x, y, run\ncoord(2): x = 204...753, y = 99...442\nrunNames(1): Kidney_MS1_ITO6\nexperimentData(5): spectrumType, spectrumRepresentation, lineScanSequence, scanType, lineScanDirection\ncentroided: TRUE \ncontinuous: FALSE \n\n\nTIMSCONVERT keeped ion mobility in the imzML data, however the peak processing functions in Cardinal cannot take advantage of it. Here we bin the spectra to project data points with the same m/z but different ion mobilities together, then do processing without ion mobility in Cardinal.\n\nmse_binned &lt;- bin(msa, resolution=20, units=\"ppm\")\nmse&lt;-summarizePixels(mse_binned)\n\nTo reduce the computation, we only process the kidney tissue region in following steps.\n\nkidney &lt;- subsetPixels(mse, x&lt;500)\nimage(kidney, 'tic')\n\n\n\n\n\n\n\n\nPlot one spectrum, though a single spectrum is centroided on m/z dimension by the instrument, it looks more similar with a profile spectrum after projection.\n\nplot(kidney, i=1234)\n\n\n\n\n\n\n\n\nTreat the data as profile spectra and process it to reduce the number of features.\n\nkidney &lt;- subsetPixels(mse_binned, x&lt;500)\ncentroided(kidney)&lt;-FALSE\nset.seed(1, kind=\"L'Ecuyer-CMRG\")\n#kidney &lt;- normalize(kidney, method='rms')\npeaks &lt;- peakProcess(kidney, SNR=3, tolerance=200, units=\"ppm\")\n\n\n\n4.1.3 Comparing ion images with/without ion mobility\nThen we load the processed data from TIMSImaging, which is already peak-picked.\n\npeaks_timsimaging &lt;- readMSIData(\"D:\\\\dataset\\\\Melanie_case_study\\\\mouse_kidney.imzML\")\npeaks_timsimaging\n\nMSImagingExperiment with 3110 features and 22978 spectra \nspectraData(1): intensity\nfeatureData(1): mz\npixelData(3): x, y, run\ncoord(2): x = 204...409, y = 175...332\nrunNames(1): mouse_kidney\nexperimentData(5): spectrumType, spectrumRepresentation, lineScanSequence, scanType, lineScanDirection\nmass range:  800.2957 to 1760.7449 \ncentroided: TRUE \n\n\nNormalize on peak-picked data for fair comparison:\n\npeaks_norm = process(normalize(peaks, method='tic'))\npeaks_timsimaging &lt;- process(normalize(peaks_timsimaging, method='tic'))\n\nPlot ion images from processsing with/without ion mobility in the same color scale.\n\nm &lt;- 1198.7\nimage(peaks_timsimaging, i = findInterval(m, mz(peaks_timsimaging))+1, zlim=c(0, 5))\n\n\n\n\n\n\n\nimage(peaks_norm, mz = m, zlim=c(0, 5))\n\n\n\n\n\n\n\n\nThe ion images from TIMSCONVERT and processed in Cardinal looks noiser, as well as less contrast between the background and kidney edge.\n\nm &lt;- 1443.59\nimage(peaks_timsimaging, i = findInterval(m, mz(peaks_timsimaging))+1, zlim=c(0, 8))\n\n\n\n\n\n\n\nimage(peaks_norm, mz = m, zlim=c(0, 8))",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>TIMSCONVERT workflow comparison</span>"
    ]
  }
]